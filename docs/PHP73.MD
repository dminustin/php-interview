## PHP 7.3. Что нового

### Смягчение требований к синтаксису Heredoc и Nowdoc

Heredoc и Nowdoc требовали ставить закрывающий идентификатор первым в новой строке.

Пример:

````php
$foo = &lt;&lt;&lt;IDENTIFIER
the crazy dog jumps over the lazy fox  
"foo" bar;  
IDENTIFIER
````


Здесь закрывающий IDENTIFIER должен быть первым символом на новой линии чтобы это работало. Кроме того, не должно было быть никаких других символов после закрывающего идентификатора (кроме ;, который является необязательным).

RFC для PHP 7.3 предлагает убрать подобные требования для улучшения читабельности кода. Прежде всего чтобы добавить отступы при использовании heredoc/nowdoc идентификаторов.

Полный список изменений в heredoc/nowdoc синтаксисе:

- Закрывающий идентификатор необязательно должен быть первым символом в строке.
- Закрывающий идентификатор имеет отступ пробелами или табами.
- Отступ (пробелы или табы) не должен быть смешанным. Если вы это сделаете, то получите Parse error: Invalid indentation - tabs and spaces cannot be mixed in .. on line ...
- Точное количество пробелов/табов, используемых перед закрывающим идентефикатором будут удалены из каждой строки heredoc/nowdoc выражения.
- Если число отступающих символов, используемых перед закрывающим идентефикатором, больше чем в любой из строк выражения, вы получите Parse error: Invalid body indentation level (expecting an indentation level of at least ..) in .. on line ..
- несколько выражений после закрывающего идентификатора будут работать без ошибок

Пока вы не используете набор идентичных heredox/nowdoc идентификаторам символов в качестве начала строки, вы на коне.


````php
$foo = &lt;&lt;&lt;HELLO  
HELLO_WORLD <-- это не будет приниматься за окончание строкового литерала
HELLOWORLD  <-- и это не будет
HELLO WORLD <-- а это будет
HELLO;
````

### Поддержка конечных запятых в вызовах функций и методов

Это простое изменение, которое разрешает использование конечных запятых в вызовах функций и методах. Это не влияет на декларирование.

Например, следующий синтаксис станет возможным:

````php

// функция
foo('bar', 'baz',); // Обратите внимание на последнюю запятую после  после 'baz'

````

В до-PHP-7.3 версиях фрагмент выше выбрасывает ошибку PHP Parse error:  syntax error, unexpected ')' in .. on line ...

Вы не можете использовать более одной запятой в конце или использовать запятые для пропуска аргументов. В основном это изменение для функции с вариативными параметрами. Также с новыми правками синтаксис массива будет выглядеть более последовательным.

Обратите внимание, что Вы не можете использовать эту возможность в объявлениях функций/методов; это неправильно:

````php
function foo($bar, $baz, ) { // nah, you can't do this.  
}
````

### Ссылки в list()

Функция list() полезна для быстрого присвоения значений переременным из массива. До версии PHP 7.3 не было возможным указать переменную по ссылке. До PHP 7.3 следующий фрагмент приводил к фатальной ошибке:

````php
$arr = ['apple', 'orange'];  
list($a, &$b) = $arr;  
$b = 'banana';  
echo $arr[1];  
// Fatal error: [] and list() assignments cannot be by reference in .. on line ..

````

Ссылкаться на non-referencable переменные нельзя: list($a, &$b) = [12, 14]; выдаст Fatal error: Cannot assign reference to non referencable value in .. on line ...

### Функция image2wbmp() объявлена устаревшей

image2wbmp() функция из расширения GD используется для вывода изображения в формате WBMP (Wireless Bitmap). В PHP 7.3 она объявлена устаревшей в пользу функции imagewbmp().

Если вы используете image2wbmp(), то просто замените название функции на imagewbmp и все будет хорошо!

### Флаги FILTER_FLAG_SCHEME_REQUIRED и FILTER_FLAG_HOST_REQUIRED при использовании FILTER_VALIDATE_URL объявлены устаревшими
TL;DR

### Регистро-независимые константы объявлены устаревшими

Функция define() позволяет объявить константу в регистро-независимом режиме. Вы должны явно объявить константу с учетом регистра, передав третьим параметром функции true. Это не поведение по-умолчанию и наверняка не согласуется с возможностью объявлять константы через ключевое слово const.

````php
define('Foo', 'Bar', true);
````

Приведенный выше код будет выбрасывать уведомление об устаревании: Deprecated: define(): Declaration of case-insensitive constants is deprecated in ...

### Опциональный выброс исключений при ошибках в функциях json_encode и json_decode

Все эти годы json_encode() и json_decode() молчали об ошибках в PHP-переменных или json-строках, что приводило к забагованному коду.

````php
try {  
json_decode("{", false, 512, JSON_THROW_ON_ERROR);  
}  
catch (\JsonException $exception) {  
echo $exception->getMessage(); // выводит "Syntax error"  
}

````

Новый \JsonException является наследником от \Exception, а также константа JSON_THROW_ON_ERROR и сам JsonException находятся в глобальном пространстве имен.

### Добавление функции is_countable()

В PHP 7.2 достаточно много устаревших и забагованных функций. Если вы в PHP 7.2. вызываете count() с использованием не-countable переменной, то PHP выведет предупреждение об этом. В общих правках было предложение проверять получаемую перменную на countable до ее использования в count().

countable-переменной является массив или объект реализующий \Countable интерфейс. Так как при проверке будет использоваться много шаблонного кода, в PHP 7.3 появилась новая функция is_countable(), проверяющая переменную на… ну… возможность использования с count().

### Добавление функций array_key_first() и array_key_last()

В PHP существует 75 различных функций для работы с массивами, но до сих пор не было простого способа получить первый и последний ключи массива без изменения указателя массива или перебора всех ключей (через array_keys()) и затем получения первого/последнего значения.

Появились две новые функции, array_key_first() и array_key_last() позволяющие это делать.

### Миграция с PCRE на PCRE2

PHP использует Perl Compatible Regular Expressions или коротко PCRE в библитеке для работы с регулярными выражениями. С версии PHP 7.2 используется 8.x версия легаси-библиотеки PCRE, а в PHP 7.3 уже будет использоваться PCRE2. Обратите внимание, что PCRE2 считается новой библитекой, хотя в значительной степени совместима с PCRE (8.x).


Новая библитека более агрессивна в валидации паттернов и может привести к ошибкам в существующем коде. Следующий фрагмент будет невалидным с PHP 7.3:


````php
preg_match('/[\w-.]+/', '');
````

PHP выбросит предупреждение Warning: preg_match(): Compilation failed: invalid range in character class at offset 3.
Проблема с шаблоном: чтобы это работало дефис должен быть перемещен в конец или экранирован.

````php
preg_match('/[\w\-.]+/', '');

````

